"use strict";angular.module("starwallet",["ngCookies","ngResource","ngSanitize","ngRoute","angularMoment","ui.router","ui.router.stateHelper"]).config(["$routeProvider","$stateProvider","stateHelperProvider","$httpProvider",function(a,b,c,d){function e(a){return"public/main/"+a}d.interceptors.push(["$q","$location",function(a,b){return{responseError:function(c){return 401===c.status&&b.path("/login"),a.reject(c)}}}]),b.state("home",{url:"",controller:"MainController"}).state("home2",{url:"/",controller:"MainController"}).state("login",{url:"/login",controller:"AuthController",templateUrl:e("views/login.html")}).state("signUp",{url:"/signup",controller:"AuthController",templateUrl:e("views/signup.html")}).state("signOut",{url:"signout",controller:["AuthService","$state",function(a,b){a.signOut().then(function(){b.go("login")})}]}).state("accountPublicDisplay",{url:"/account-public/:accountId",controller:"AccountPublicDisplayController",templateUrl:e("views/account/account-public-display.html")}),c.setNestedState({name:"withNav",url:"/u:userId",controller:"NavController",templateUrl:e("views/withNav.html"),children:[{name:"userSettings",url:"/settings",controller:"UserSettingsController",templateUrl:e("views/user-settings.html")},{name:"cards",url:"/cards",controller:"CardListController",templateUrl:e("views/card/card-list.html")},{name:"cardImages",url:"/card-images",controller:"CardImageListController",templateUrl:e("views/card/card-image-list.html")},{name:"registration",url:"/register",controller:"RegistrationController",templateUrl:e("views/registration.html")},{name:"coupons",url:"/coupons",controller:"CouponListController",templateUrl:e("views/coupon/coupon-list.html")},{name:"couponDisplay",url:"/coupons/:number",controller:"CouponDisplayController",templateUrl:e("views/coupon/coupon-display.html")},{name:"cardDisplay",url:"/cards/:number",controller:"CardDisplayController",templateUrl:e("views/card/card-display.html")},{name:"accountList",url:"/account",controller:"IdentityListController",templateUrl:e("views/identity/identity-list.html"),children:[{name:"addAccount",url:"/edit",controller:"IdentityEditController",templateUrl:e("views/identity/identity-edit.html")},{name:"editAccount",url:"/edit/:accountId",controller:"IdentityEditController",templateUrl:e("views/identity/identity-edit.html")},{name:"accountDisplay",url:"/display/:accountId",controller:"AccountDisplayController",templateUrl:e("views/account/account-display.html")}]}]})}]),function(a){function b(a,b,c,d,e,f){a.vm=this,this.$state=e,a.href=e.href,this.accountService=c,this.accountId=+e.params.accountId,this.identityService=b,this.accountService=c,this.params=e.params,this.list(d.userId);var g=this;g.responsiveClasses="",this.getResponsiveClasses(),this.$timeout=f,a.$on("$stateChangeSuccess",function(a,b,c){g.setActive(+c.accountId),g.getResponsiveClasses(+c.accountId),g.list(d.userId)})}var c=["$scope","IdentityService","AccountService","$stateParams","$state","$timeout"];return b.prototype={refresh:function(){var a=this;this.items&&this.items.length&&(a.isLoading=!0,a.accountService.refreshAll().then(function(){a.isLoading=!1,a.list(a.$state.params.userId)}))},list:function(a){var b=this;this.identityService.list(a).then(function(a){return b.items=a,b.setActive(+b.$state.params.accountId),a})},getResponsiveClasses:function(a){a?this.responsiveClasses=" visible-lg visible-md visible-sm":this.responsiveClasses=""},setActive:function(a){this.items&&_.forEach(this.items,function(b){b.isActive=b.id===a})}},b.$inject=c,a.controller("IdentityListController",b),b}(angular.module("starwallet")),function(a){function b(a,b,c,d,e){a.vm=this,this.$window=e,this.identityService=c,this.$state=d,this.params=b,this.acc={userName:"",password:"",cardNumber:"",pinCode:"",email:"",firstName:"",lastName:"",phoneNumber:""},this.revealPassword=!1,a.href=d.href,this.isLoading=!1,this.isUpdating=!1,this.getForm()}var c=["$scope","$stateParams","IdentityService","$state","$window"];return b.prototype={getForm:function(){var a=this;this.params.accountId&&(a.isLoading=!0,this.identityService.get(this.params.accountId,this.params.userId).then(function(b){a.account=b,a.isLoading=!1}))},save:function(a){var b=this;b.alert=void 0,b.isUpdating=!0,a.activationEmail="",a.isActive=!1,a.id?this.identityService.update(a,this.params.userId).then(function(){b.isUpdating=!1},function(){b.isUpdating=!1,b.alert={message:"Authentication error"}}):(a.id=0,this.identityService.add(a,this.params.userId).then(function(a){b.isUpdating=!1,b.$state.go("withNav.accountList.editAccount",angular.extend(b.params,{accountId:a}))},function(){b.isUpdating=!1,b.alert={message:"Authentication error"}}))},remove:function(a){var b=this;b.isUpdating=!0,this.$window.confirm("Do you really want to delete this account?")&&this.identityService.remove(a,this.params.userId).then(function(){b.isUpdating=!1,b.$state.go("withNav.accountList",b.params)})}},b.$inject=c,a.controller("IdentityEditController",b),b}(angular.module("starwallet")),function(a,b){function c(a,b,c,d){a.vm=this,this.accountService=c,this.accountId=d.params.accountId,this.userId=d.params.userId,this.isLoading=!1,this.get(this.accountId),this.showAll=!1;var e=this;a.$watch("vm.showAll",function(){e.couponsFilter=e.getCouponsFilter(e.showAll)}),a.href=d.href,this.couponsFilter=this.getCouponsFilter(this.showAll)}var d=["$scope","$stateParams","AccountService","$state"];return c.prototype={update:function(a){var b=this;b.alert=void 0,b.identity=void 0,a&&a.preventDefault(),b.isRefreshing=!0,this.accountService.getByIdentityId(this.accountId,!0).then(function(a){b.activeCouponsCount=b.countActiveCoupons(a.coupons),b.accountInfo=a,b.isRefreshing=!1},function(){b.isRefreshing=!1,b.alert={message:"Could not load the data from Starbucks"}})},getLastTransactionDate:function(a){return b.max(b.map(a,function(a){return a.date}))},getCouponsFilter:function(a){return a?{}:{isActive:!0}},activate:function(){var a=this;this.accountService.activate(this.accountId,this.userId).then(function(){a.update()})},get:function(a){var b=this;this.isLoading=!0,this.accountService.getByIdentityId(a,!1).then(function(a){b.activeCouponsCount=b.countActiveCoupons(a.coupons),b.accountInfo=a,b.isLoading=!1,new Date-new Date(a.syncDate)>12e4&&b.update()},function(a){b.identity=a.data,b.isLoading=!1,b.showActivationButton=!0,b.alert={message:"Could not load the data from Starbucks"}})},countActiveCoupons:function(a){return b.filter(a,"isActive").length}},c.$inject=d,a.controller("AccountDisplayController",c),c}(angular.module("starwallet"),_),function(a,b){function c(a,b,c){a.vm=this,this.accountService=b,this.accountId=c.params.accountId,this.userId=c.params.userId,this.isLoading=!1,this.get(this.accountId),this.showAll=!1;var d=this;a.$watch("vm.showAll",function(){d.couponsFilter=d.getCouponsFilter(d.showAll)}),a.href=c.href,this.couponsFilter=this.getCouponsFilter(this.showAll)}var d=["$scope","AccountService","$state"];return c.prototype={update:function(a){var b=this;b.alert=void 0,b.identity=void 0,a&&a.preventDefault(),b.isRefreshing=!0,this.accountService.getByIdentityId(this.accountId,!0).then(function(a){b.activeCouponsCount=b.countActiveCoupons(a.coupons),b.accountInfo=a,b.isRefreshing=!1},function(){b.isRefreshing=!1,b.alert={message:"Could not load the data from Starbucks"}})},getLastTransactionDate:function(a){return b.max(b.map(a,function(a){return a.date}))},getCouponsFilter:function(a){return a?{}:{isActive:!0}},activate:function(){var a=this;this.accountService.activate(this.accountId,this.userId).then(function(){a.update()})},get:function(a){var b=this;this.isLoading=!0;var c=function(a){b.activeCouponsCount=b.countActiveCoupons(a.coupons),b.accountInfo=a,b.isLoading=!1,new Date-new Date(a.syncDate)>12e4&&b.update()},d=function(a){b.identity=a.data,b.isLoading=!1,b.showActivationButton=!0,b.alert={message:"Could not load the data from Starbucks"}};this.accountService.getByIdentityId(a,!1).then(c,d)},countActiveCoupons:function(a){return b.filter(a,"isActive").length}},c.$inject=d,a.controller("AccountPublicDisplayController",c),c}(angular.module("starwallet"),_),function(a){function b(a,b,c){a.vm=this;var d=this;a.href=b.href,c.list(b.params.userId).then(function(a){d.cards=a})}var c=["$scope","$state","CardService"];return b.prototype={},b.$inject=c,a.controller("CardListController",b),b}(angular.module("starwallet")),function(a,b){function c(a,b,c){a.vm=this;var d=this;this.$state=c,this.cardService=b,this.card={},b.get(c.params.number,c.params.userId).then(function(a){d.card=a,d.barcodeUrl=d.getBarcodeUrl(d.card)})}var d=["$scope","CardService","$state"];return c.prototype={savePin:function(){var a=this;a.isSaving=!0,this.cardService.savePin(this.card.data.pin,this.card.data.number,this.$state.params.userId).then(function(){a.isSaving=!1,a.barcodeUrl=a.getBarcodeUrl(a.card),a.isPinCodeVisible=!1})},getBarcodeUrl:function(a){if(a.data.pin){var c=Math.round(1e9*Math.random());return b.BarCode.cardBarCode(this.$state.params.number).url+"?v="+c}return""},showPinCode:function(a){a.preventDefault(),this.isPinCodeVisible=!this.isPinCodeVisible}},c.$inject=d,a.controller("CardDisplayController",c),c}(angular.module("starwallet"),jsRoutes.controllers),function(a){function b(a){var b="https://cabinet.plas-tek.ru/cardimage.ashx?c=728014766415&w=108&s=";a.images=this.getImages(b)}var c=["$scope"];return b.prototype={getImages:function(a){for(var b=[],c=0;1e3>c;c++){var d=c,e={url:a+d,cardNumber:d};b.push(e)}return b}},b.$inject=c,a.controller("CardImageListController",b),b}(angular.module("starwallet")),function(a){function b(a,b,c){a.vm=this,this.$state=c,this.authService=b}var c=["$scope","AuthService","$state"];return b.prototype={signIn:function(){if(this.user&&this.user.userName&&this.user.password){var a=this;a.alert=void 0,a.isLoading=!0,this.authService.signIn(this.user).then(function(b){b.isAuthenticated?a.$state.go("withNav.accountList",{userId:b.userId}):(a.isLoading=!1,a.alert={type:"error",message:"Incorrect email or password"})})}},signUp:function(){if(this.user&&this.user.userName&&this.user.password){var a=this;a.alert=void 0,a.isLoading=!0,this.authService.signUp(this.user).then(function(b){b.isAuthenticated?a.$state.go("withNav.accountList",{userId:b.userId}):(a.isLoading=!1,a.alert={type:"error",message:"An error occured during signing up"})})}}},b.$inject=c,a.controller("AuthController",b),b}(angular.module("starwallet")),function(a){function b(a,b,c){this.userId=c.userId}var c=["$scope","$state","$stateParams"];return b.prototype={},b.$inject=c,a.controller("NavController",b),b}(angular.module("starwallet")),function(a){function b(a,b){b.checkAuth().then(function(b){b.isAuthenticated?a.go("withNav.accountList",{userId:b.userId}):a.go("login")})}var c=["$state","AuthService"];return b.$inject=c,a.controller("MainController",b),b}(angular.module("starwallet")),function(a){function b(a,b,c){a.vm=this;var d=this;b.list(c.params.userId).then(function(a){d.coupons=a})}var c=["$scope","CouponService","$state"];return b.prototype={},b.$inject=c,a.controller("CouponListController",b),b}(angular.module("starwallet")),function(a){function b(a,b,c){a.vm=this,b.get(c.params.number).then(function(a){this.coupon=a})}var c=["$scope","CouponService","$state"];return b.prototype={},b.$inject=c,a.controller("CouponDisplayController",b),b}(angular.module("starwallet")),function(a,b){function c(a,c,d,e){a.vm=this,this.$state=d,this.identityService=c,this.params=d.params;var f=this,g=b.word({syllables:3});f.acc={auth:{id:0,userName:g,password:b.string({pool:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",length:12}),activationEmail:"",isActive:!1},card:{number:7280},firstName:b.first(),lastName:b.last()},e.getSettings(this.params.userId).then(function(a){f.acc.phoneNumber=a.phone,f.acc.firstName=a.firstName,f.acc.email=g+"@"+a.emailDomain})}var d=["$scope","IdentityService","$state","UserService"];return c.prototype={saveNew:function(a){var b=this;b.alert=void 0,b.isUpdating=!0,this.identityService.register(a,this.params.userId).then(function(){b.isUpdating=!1,b.alert={type:"success",message:"The card is successfully registered!"}},function(a){b.isUpdating=!1,b.alert={type:"danger",message:a.data}})}},c.$inject=d,a.controller("RegistrationController",c),c}(angular.module("starwallet"),new Chance),function(a){function b(a,b,c){a.vm=this;var d=this;this.$state=c,this.userService=b,b.getSettings(c.params.userId).then(function(a){d.settings=a})}var c=["$scope","UserService","$state"];return b.prototype={save:function(){var a=this;this.isUpdating=!0,this.userService.saveSettings(this.settings,this.$state.params.userId).then(function(){a.isUpdating=!1})}},b.$inject=c,a.controller("UserSettingsController",b),b}(angular.module("starwallet")),function(a,b){function c(a,b){this.$http=a,this.pw=b}var d=["$http","PromiseWrapper"];return c.prototype={get:function(a,c){return this.$http(b.Identity.get(a,c)).then(function(a){return a.data})},list:function(a){return this.$http(b.Identity.list(a)).then(function(a){return a.data})},add:function(a,c){return this.$http(angular.extend(b.Identity.add(c),{data:a})).then(function(a){return a.data})},register:function(a,c){return this.$http(angular.extend(b.Identity.register(c),{data:a})).then(function(a){return a.data})},update:function(a,c){return this.$http(angular.extend(b.Identity.update(c),{data:a})).then(function(a){return a.data})},remove:function(a,c){return this.$http(b.Identity.remove(a,c)).then(function(a){return a.data})}},c.$inject=d,a.service("IdentityService",c),c}(angular.module("starwallet"),jsRoutes.controllers),function(a,b){function c(a){this.$http=a}var d=["$http"];return c.prototype={list:function(a){return this.$http(b.Coupon.list(a)).then(function(a){return a.data})},get:function(a,c){return this.$http(b.Coupon.get(a,c)).then(function(a){return a.data})}},c.$inject=d,a.service("CouponService",c),c}(angular.module("starwallet"),jsRoutes.controllers),function(a,b){function c(a){this.$http=a}var d=["$http"];return c.prototype={list:function(a){return this.$http(b.Card.list(a)).then(function(a){return a.data})},get:function(a,c){return this.$http(b.Card.get(a,c)).then(function(a){return a.data})},savePin:function(a,c,d){return this.$http(angular.extend(b.Card.savePin(c,d),{data:{pinCode:a}})).then(function(a){return a.data})}},c.$inject=d,a.service("CardService",c),c}(angular.module("starwallet"),jsRoutes.controllers),function(a,b){function c(a){this.$http=a}var d=["$http"];return c.prototype={getByIdentityId:function(a,c){return this.$http(b.Account.get(a,c)).then(function(a){return a.data})},activate:function(a,c){return this.$http(b.Account.activate(a,c)).then(function(a){return a.data})},refreshAll:function(){return this.$http(b.Account.refreshAll()).then(function(a){})}},c.$inject=d,a.service("AccountService",c),c}(angular.module("starwallet"),jsRoutes.controllers),function(a,b){function c(a,b){this.pw=b,this.$http=a}var d=["$http","PromiseWrapper"];return c.prototype={checkAuth:function(){return this.$http(b.Security.checkAuth()).then(function(a){return a.data})},signIn:function(a){return this.$http(angular.extend(b.Security.signIn(),{data:a})).then(function(a){return a.data})},signUp:function(a){return this.$http(angular.extend(b.Security.signUp(),{data:a})).then(function(a){return a.data})},signOut:function(){return this.$http(b.Security.signOut()).then(function(a){return a.data})}},c.$inject=d,a.service("AuthService",c),c}(angular.module("starwallet"),jsRoutes.controllers),function(a,b){function c(a){this.$http=a}var d=["$http"];return c.prototype={getSettings:function(a){return this.$http(b.User.getSettings(a)).then(function(a){return a.data})},saveSettings:function(a,c){return this.$http(angular.extend(b.User.saveSettings(c),{data:a})).then(function(a){return a.data})}},c.$inject=d,a.service("UserService",c),c}(angular.module("starwallet"),jsRoutes.controllers),function(a){function b(a){this.$q=a}var c=["$q"];return b.prototype={wrap:function(a){var b=this.$q.defer();return b.resolve(a()),b.promise}},b.$inject=c,a.service("PromiseWrapper",b),b}(angular.module("starwallet")),function(a,b){function c(a){return"/api/barcode/card-barcode/"+a+"?v="+e}function d(){return e=Math.round(1e9*Math.random()),c}var e=1;return a.filter("Barcode",d),d}(angular.module("starwallet"),jsRoutes.controllers);